<div>
    <each-element
        update="messagesHistory"
        js="messagesHistory.value"
        element="message"
        class="flex flex-col gap-4 max-w-[800px]"
    >
        <div class="flex flex-col">
            <if-element
                class="bg-gray-800 p-3 rounded-2xl self-end max-w-[70%] my-10"
                update="messagesHistory"
                js="message.role == 'user'"
            >
                <js-element
                    js="message.content"
                    update="messagesHistory"
                    html="true"
                    >Message</js-element
                >
            </if-element>
            <else-element update="messagesHistory">
                <js-element
                    js="message.content"
                    update="messagesHistory"
                    html="true"
                    >Message</js-element
                ></else-element
            >
        </div>
    </each-element>
    <div class="grid grid-cols-[auto_5rem] gap-4 mt-10">
        <input
            type="text"
            id="message"
            placeholder="Type your message here"
            class="outline p-2"
        />
        <button onclick="ask()" class="border p-2">Send</button>
    </div>
</div>
<style>
    body {
        padding: 16px;
        background-color: black;
        color: white;
        display: flex;
        justify-content: center;
    }

    h1 {
        font-size: 2rem;
        margin-bottom: 16px;
    }
    h2 {
        font-size: 1.5rem;
        margin-bottom: 16px;
    }
    h3 {
        font-size: 1.25rem;
        margin-bottom: 16px;
    }
    h4 {
        font-size: 1rem;
        margin-bottom: 16px;
    }
    h5 {
        font-size: 0.875rem;
        margin-bottom: 16px;
    }
    h6 {
        font-size: 0.75rem;
        margin-bottom: 16px;
    }
    hr {
        margin: 16px 0;
    }
    ul {
        margin: 16px 0;
        padding-left: 20px;
    }
</style>

<script src="/lib/cookies.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
    let password = getCookie("password");
    if (!password) {
        password = prompt("Enter your password");
        setCookie("password", password, 365);
    }
    const messagesHistory = new dynamicVariable("messagesHistory", []);

    fetchMessages();

    async function ask() {
        let message = document.getElementById("message").value;
        if (!message) return;

        let newMessagesHistory = [
            ...messagesHistory.value,
            {
                role: "user",
                content: message,
            },
        ];
        messagesHistory.set(newMessagesHistory);

        const answer = (
            await (
                await fetch("/api/v1/ask", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        Authorization: `Bearer ${password}`,
                    },
                    body: JSON.stringify({
                        question: message,
                    }),
                })
            ).json()
        ).answer;
        newMessagesHistory.push(
            formatMessageObject({
                role: "assistant",
                content: answer,
            })
        );
        messagesHistory.set(newMessagesHistory);
    }

    async function fetchMessages() {
        try {
            const response = await fetch("/api/v1/messagesHistory", {
                headers: {
                    Authorization: `Bearer ${password}`,
                },
            });

            if (response.status !== 200) {
                alert("Error");
                return;
            }

            const data = await response.json();
            messagesHistory.set(
                data.messages.map((x) => formatMessageObject(x)) || []
            );
        } catch (error) {
            console.error("Failed to fetch messages:", error);
            alert("Error fetching messages");
        }
    }

    function formatMessageObject(message) {
        if (!message.content.includes("<think>")) {
            return {
                role: message.role,
                content: marked.parse(message.content),
            };
        }
        let [thinking, content] = message.content.split("</think>");
        thinking = thinking.split("<think>")[1];
        return {
            role: message.role,
            content: marked.parse(content),
            thinking: thinking,
        };
    }
</script>
